<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>
        Graph big number files
    </title>

    <link rel="stylesheet" href="css/layout.css"/>
    <script type="text/javascript" src="js/bower_components/js-logger/src/logger.min.js">
    </script>
    <script type="text/javascript" src="js/bower_components/jquery/dist/jquery.min.js">
    </script>
    <link rel="stylesheet" href="js/bower_components/jquery-ui/themes/smoothness/jquery-ui.css">
    <script src="js/bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/Helpers.js"></script>
    <script src="js/ConnectionManager.js"></script>
    <script src="js/Level.js"></script>
    <script src="js/D3Drawer.js"></script>
    <script src="js/Holder.js"></script>
    <script src="js/Application.js"></script>

    <style>

        body {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            /*shape-rendering: crispEdges;*/
        }

        .x.axis path {
            display: none;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        #container {
            width: 100%;
            margin: auto;
        }

        ul li {
            margin: 0 10px;
            list-style: none;
        }

        li.inline {
            display: inline-block;
            width: auto;
        }

        ul {
            margin: 10px;
            padding: 5px;
            text-align: center;
        }

        #help > ul{
            text-align: left;
        }

        .nice {
            border: 1px solid #555;
            border-radius: 5px;
            box-shadow: 5px 5px 2px #AAA;
        }

        #msg_holder {
            height: 50px;
        }

        div.hidden {
            display: none;
            visibility: hidden;
        }


    </style>


</head>

<body>
<div id="container">
    <div id="elems_menu">
        <ul class="nice">
            <li class="inline" style="float:left;">
                <button id="refresh"> Refresh</button>
            </li>
            <li class="inline" style="float:left;">
                <button id="DialogChan"> Channels</button>
            </li>
            <li class="inline" style="float:left;">
                <button id="DialogOptions"> Options</button>
            </li>
            <li class="inline" style="float:left;">
                <button id="DialogHelp"> Help</button>
            </li>
            <li class="inline"> Status: <label id="conn_status">Disconnected</label></li>
            <li class="inline">
                <input type="text" value="ws://localhost:10888/" id="ws_host"/>
                <button id="ws_connect">Connect!</button>
            </li>
            <li style="float:right;" class="inline">
                <label>Lvl:</label> <input type="text" value="" id="i_level"/>
                <label>Tile:</label> <input type="text" value="" id="i_tile"/>
                <button id="pos_set">Move</button>
            </li>
        </ul>

    </div>
    <div id="controls">
        <ul class="nice">
            <li class="inline">
                <button id="moveLeft">&lt;&lt;</button>
                <button id="moveRight">&gt;&gt;</button>
            </li>

            <li class="inline">
                <button id="moveLeftPos">&lt;</button>
                <button id="moveRightPos">&gt;</button>
            </li>
            <li class="inline">
                <button id="scaleDown"> -</button>
                <button id="scaleUp"> +</button>
            </li>
            <li class="inline">
                <button id="yUp">Y-DOWN</button>
                <button id="yDown">Y-UP</button>
            </li>
            <li class="inline">
                <button id="moveUp">UP</button>
                <button id="moveDown">DOWN</button>
            </li>
        </ul>
    </div>

    <div id="grabber" class="nice" style="width: 99%;height: 700px;">
        <div id="graph_container" style="width: 99%; height: 95%;">
        </div>
    </div>

    <div id="hid_cont" class="dialog hidden">

        <div id="chan_opt" title="Select channels">
            <p> Enabled channels: </p>
            <ul id="chan_cont">
            </ul>
        </div>

        <div id="options" class="dialog" title="Options">
            <ul>
                <li>
                    <input type="text" value="1" id="factor_val"/>
                    <button id="factor_set">Factor</button>
                </li>
                <li>
                    Background color:
                    <input type="color" id="bg_color">
                </li>
                <li>
                    Stroke color:
                    <input type="color" id="fg_color">
                </li> <li>
                    Area color:
                    <input type="color" id="area_color">
                </li>
            </ul>
        </div>

        <div id="help" class="dialog" title="Help">
            <ul>
                <li>This is help!</li>
            </ul>
        </div>


    </div>

    <div id="Messages">
        <ul id="msg_holder">

        </ul>
    </div>

</div>


<script>
    Logger.useDefaults();
    Logger.info("Logger Ready ....");

    var main = function ()
    {

        var graph_container = "#graph_container";
        var main_graph = document.getElementById("graph_container");
        var drawer = new D3Drawer(graph_container);
        var host = "ws://localhost:10888/";
        var manager = null;
        var _this = this;
        this.selected = null;
        var val_node = d3.select("#factor_val").node();
        val_node.value = window.icfg.factor;

        window.stat.updateConnectionStatus = function (stat)
        {
            window.icfg.status = stat;
            $("#conn_status").text((stat) ? "Connected" : "Disconnected");
        };

        function change_width(num)
        {
            var w = parseInt(main_graph.style.width);
            console.log("WIDTH: %d", w);
            main_graph.style.width = (w + num) + "px";
            console.log("Resize event called!");
            if (manager) {
                manager.moveByPos(0);
            }
            drawer.reload();

        }
        var bg_color =$("#bg_color");
        var fg_color =$("#fg_color");
        var area_color=$("#area_color");


        fg_color.on('input', function(){
            console.log("Color changed!", fg_color.val());
            drawer.strokeColor = fg_color.val();
            drawer.redrawLevel();
        });

        area_color.on('input', function(){
            console.log("Color changed!", area_color.val());
            drawer.areaColor = area_color.val();
            drawer.redrawLevel();
        });

        bg_color.on('input', function()
                             {
                                 console.log("Background Color changed!",  bg_color.val());
                                 $("svg").css("background-color", bg_color.val());
                             });

        d3.select("#DialogOptions").on("click", function ()
        {
            $("#options").dialog();
        });

        d3.select("#DialogHelp").on("click", function ()
        {
            $("#help").dialog();
        });

        d3.select("#DialogChan").on("click", function ()
        {
            if (!manager) return;

            var n_chan = window.config.channels;

            for (var i = 0; i < n_chan; i++) {
                var ret = drawer.disabledChans[i];
                var val = (ret) ? 0 : 1;
                // create the necessary elements
                var label = document.createElement("li");
                var description = document.createTextNode("Channel " + i);
                var checkbox = document.createElement("input");

                checkbox.type = "checkbox";    // make the element a checkbox
                checkbox.name = "chan_ch_" + i;      // give it a name we can check on the server side
                checkbox.checked = val;         // make its value "pair"
                checkbox.value = "" + i;
                checkbox.id = "ch_ch_" + i;
                label.appendChild(checkbox);   // add the box to the element
                label.appendChild(description);// add the description to the element

                checkbox.onclick = function (event)
                {

                    var ch = event.target;
                    console.log(ch);
                    if (ch.checked) {
                        drawer.chanStat(ch.value, 1);
                    }
                    else {
                        drawer.chanStat(ch.value, 0);
                    }
                    drawer.redrawLevel();
                };

                // add the label element to your div
                document.getElementById('chan_cont').appendChild(label);
            }

            var chan = $("#chan_opt");

            chan.dialog();

        });

        d3.select("#factor_set").on("click", function ()
        {
            var val_node = d3.select("#factor_val").node();
            var cfg = window.icfg;
            cfg.factor = val_node.value;
            manager.calculateWindowSize();
            _this.moveByPos(0);
            drawer.reload();
        });

        d3.select("#sizeInc").on("click", function ()
        {
            var inc = 50;
            change_width(inc);

        });

        d3.select("#sizeDec").on("click", function ()
        {
            var dec = -50;
            change_width(dec)
        });

        d3.select("#moveRight").on("click", function ()
        {
            if (!manager) return;
            _this.moveByTile(0, +1);
        });
        d3.select("#moveLeft").on("click", function ()
        {
            if (!manager) return;
            _this.moveByTile(0, -1);
        });

        d3.select("#moveRightPos").on("click", function ()
        {
            if (!manager) return;
            _this.moveByPos(+1);
        });
        d3.select("#moveLeftPos").on("click", function ()
        {
            if (!manager) return;
            _this.moveByPos(-1);
        });

        d3.select("#moveUp").on("click", function ()
        {
            if (!manager) return;
            _this.stepLvl(1);
        });
        d3.select("#moveDown").on("click", function ()
        {
            if (!manager) return;
            _this.stepLvl(-1);
        });

        d3.select("#yUp").on("click", function ()
        {
            if (!manager) return;
            drawer.moveY(100);
            drawer.redrawLevel();
        });
        d3.select("#yDown").on("click", function ()
        {
            if (!manager) return;
            drawer.moveY(-100);
            drawer.redrawLevel();
        });

        d3.select("#ws_connect").on("click", function ()
        {
            host = document.getElementById("ws_host").value;
            window.icfg.current.level = 0;
            manager = new ApplicationManager(host, drawer);
        });

        var main_node = d3.select(graph_container).node();
        main_node.onresize = function ()
        {
            console.log("Resize event called!");
            drawer.reload();
            if (manager) {
                manager.moveTile(0);
            }
        };

        function getCoords(elem)
        { // crossbrowser version
            if (!elem) return null;
            var box = elem.getBoundingClientRect();

            var body = document.body;
            var docEl = document.documentElement;

            var scrollTop = window.pageYOffset || docEl.scrollTop || body.scrollTop;
            var scrollLeft = window.pageXOffset || docEl.scrollLeft || body.scrollLeft;

            var clientTop = docEl.clientTop || body.clientTop || 0;
            var clientLeft = docEl.clientLeft || body.clientLeft || 0;

            var top = box.top + scrollTop - clientTop;
            var left = box.left + scrollLeft - clientLeft;

            return {top: Math.round(top), left: Math.round(left)};
        }

        var prev_mouseX = null, prev_mouseY = null;
        var clicked = false;

        window.onmousemove = function (e)
        {
            if (!window.config) return;
            if (clicked == true) {
                var diff_y = prev_mouseY - e.clientY;
                var diff_x = prev_mouseX - e.clientX;
                prev_mouseY = e.clientY;
                prev_mouseX = e.clientX;
                drawer.scaleY(diff_y / 2);
                manager.movePosNoDraw(diff_x / 10);
                drawer.redrawLevel();
            }
        };

        $('#grabber').mousewheel(function (event)
                                 {
                                     if (!window.config) return;
                                     manager.scaleX(-event.deltaY * event.deltaFactor);
                                     if (drawer.deltaX) {
                                         drawer.scaleY(event.deltaX * event.deltaFactor);
                                     }
                                     drawer.drawLevel();
                                 });

        var grb_d3 = d3.select("#grabber");
        var grabber = grb_d3.node();

        grabber.onmousedown = function (e)
        {
            if (!window.config) {
                return;
            }
            drawer.drawTiles = false;
            clicked = true;
            prev_mouseX = e.clientX;
            prev_mouseY = e.clientY;
            if (e.stopPropagation) e.stopPropagation();
            if (e.preventDefault) e.preventDefault();

        };

        grabber.onmouseup = function (e)
        {
            if (!window.config) return;
            drawer.drawTiles = true;
            clicked = false;
            prev_mouseX = null;
            prev_mouseY = null;
            drawer.drawLevel();
        };

        main_graph.onclick = function (e)
        {
            if (!window.config) return;
            var svg = d3.select(".path_container");
            var w_pos = getCoords(svg.node());
            var x = e.clientX;
            var ix = drawer.getSelectX(x - w_pos.left);

            _this.selected = ix;
            drawer.drawLevel();

        };

        this.moveByTile = function (lvl_dir, ind_dir)
        {
            if (!manager) return;

            manager.move(lvl_dir, ind_dir);

        };

        this.moveByPos = function (ind_dir)
        {
            if (!manager) return;

            manager.movePos(ind_dir);

        };

        this.stepLvl = function (dir)
        {
            if (!manager) return;
            if (_this.selected) {
                manager.moveToPosition(dir, _this.selected);

            }
            else {
                _this.moveByTile(dir, 0);
            }
        };

        window.onkeydown = function checkKey(e)
        {

            e = e || window.event;

            if (e.altKey) {
                if (e.keyCode == 67) {
                    host = document.getElementById("ws_host").value;
                    manager = new ApplicationManager(host, drawer);
                }

            }

            if (e.keyCode == '38') {
                // up arrow
                _this.stepLvl(1);
            }
            else if (e.keyCode == '40') {
                // down arrow
                if (!manager) return;
                _this.stepLvl(-1);
            }
            else if (e.keyCode == '37') {
                // left arrow
                if (!manager) return;
                _this.moveByPos(-1);
            }
            else if (e.keyCode == '39') {
                // right arrow
                if (!manager) return;
                _this.moveByPos(+1);

            }
        };

        var addEvent = function (object, type, callback)
        {
            if (object == null || typeof(object) == 'undefined') return;
            if (object.addEventListener) {
                object.addEventListener(type, callback, false);
            }
            else if (object.attachEvent) {
                object.attachEvent("on" + type, callback);
            }
            else {
                object["on" + type] = callback;
            }
        };

        addEvent(window, "resize", function (event)
        {
            drawer.reload();
            console.log('Window was resized.');
            if (_this.manager) {
                _this.manager.calculateWindowSize();
                _this.moveByPos(0);
            }

        });

    };

    main();


</script>


</body>


</html>
