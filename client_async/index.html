<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>
        Graph big number files
    </title>

    <link ref="stylesheet" href="css/layout.css"/>
    <script type="text/javascript" src="js/bower_components/js-logger/src/logger.min.js">
    </script>
    <script type="text/javascript" src="js/bower_components/jquery/dist/jquery.min.js">
    </script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/Helpers.js"></script>
    <script src="js/ConnectionManager.js"></script>
    <script src="js/Level.js"></script>
    <script src="js/D3Drawer.js"></script>
    <script src="js/Holder.js"></script>
    <script src="js/Application.js"></script>

    <style>

        body {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            /*shape-rendering: crispEdges;*/
        }

        .x.axis path {
            display: none;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        #container {
            width: 100%;
            margin: auto;
        }

        ul li {
            list-style: none;
            display: inline-block;
        }


    </style>


</head>

<body>
<div id="container">
    <div id="elems_menu">
        <ul>
            <li>
                <input type="text" value="ws://localhost:10888/" id="ws_host"/>
                <button id="ws_connect">Connect!</button>
            </li>
        </ul>
        <ul>
            <li>
                <button id="moveLeft">&lt;&lt;</button>
                <button id="moveRight">&gt;&gt;</button>
            </li>

            <li>
                <button id="moveLeftPos">&lt;</button>
                <button id="moveRightPos">&gt;</button>
            </li>
        </ul>
        <ul>
            <li>
                Scale:
                <button id="scaleUp">+</button>
                <button id="scaleDown">-</button>
            </li>
            <li>
                <button id="moveUp">UP</button>
            </li>
            <li>
                <button id="moveDown">DOWN</button>
            </li>
        </ul>

    </div>

    <div id="grabber" style="width: 99%;height: 650px; border: 1px solid black">
        <div id="graph_container" style="width: 95%; height: 600px;">

        </div>
    </div>

</div>


<script>
    Logger.useDefaults();
    Logger.info("Logger Ready ....");

    var main = function () {

        var graph_container = "#graph_container";
        var main_graph = document.getElementById("graph_container");
        var drawer = new D3Drawer(graph_container);
        var host = "ws://localhost:10888/";
        var manager = null;
        var stop = true;
        var _this = this;
        this.selected = null;

        function change_width(num) {
            var w = parseInt(main_graph.style.width);
            console.log("WIDTH: %d", w);
            main_graph.style.width = (w + num) + "px";
            console.log("Resize event called!");
            drawer.reload();
            if (manager)
            {
                manager.moveByPos(0);
            }
        }

        d3.select("#sizeInc").on("click", function () {
            var inc = 50;
            change_width(inc);

        });

        d3.select("#sizeDec").on("click", function () {
            var dec = -50;
            change_width(dec)
        });

        d3.select("#moveRight").on("click", function () {
            if (!manager) return;
            _this.moveByTile(0, +1);
        });
        d3.select("#moveLeft").on("click", function () {
            if (!manager) return;
            _this.moveByTile(0, -1);
        });


        d3.select("#moveRightPos").on("click", function () {
            if (!manager) return;
            _this.moveByPos(+1);
        });
        d3.select("#moveLeftPos").on("click", function () {
            if (!manager) return;
            _this.moveByPos(-1);
        });

        d3.select("#moveUp").on("click", function () {
            if (!manager) return;
            _this.stepLvl(1);
        });
        d3.select("#moveDown").on("click", function () {
            if (!manager) return;
            _this.stepLvl(-1);
        });

        d3.select("#scaleUp").on("click", function () {
            if (!manager) return;
            manager.scaleX(1000);
        });
        d3.select("#scaleDown").on("click", function () {
            if (!manager) return;
            manager.scaleX(-1000);
        });


        d3.select("#ws_connect").on("click", function () {
            host = document.getElementById("ws_host").value;
            window.icfg.current.level = 0;
            manager = new ApplicationManager(host, drawer);
        });

        var main_node = d3.select(graph_container).node();
        main_node.onresize = function () {
            console.log("Resize event called!");
            drawer.reload();
            if (manager)
            {
                manager.moveTile(0);
            }
        };

        function getCoords(elem) { // crossbrowser version
            if (!elem) return null;
            var box = elem.getBoundingClientRect();

            var body = document.body;
            var docEl = document.documentElement;

            var scrollTop = window.pageYOffset || docEl.scrollTop || body.scrollTop;
            var scrollLeft = window.pageXOffset || docEl.scrollLeft || body.scrollLeft;

            var clientTop = docEl.clientTop || body.clientTop || 0;
            var clientLeft = docEl.clientLeft || body.clientLeft || 0;

            var top = box.top + scrollTop - clientTop;
            var left = box.left + scrollLeft - clientLeft;

            return {top: Math.round(top), left: Math.round(left)};
        }


        var prev_mouseX = null, prev_mouseY = null;
        var clicked = false;

        window.onmousemove = function (e) {
            if (!window.config) return;
            if (clicked == true)
            {
                var diff_y = prev_mouseY - e.clientY;
                var diff_x = prev_mouseX - e.clientX;
                prev_mouseY = e.clientY;
                prev_mouseX = e.clientX;
                drawer.scaleY(diff_y / 2);
                manager.movePos(diff_x / 10);
                drawer.redrawLevel();
            }
        };

        $('#grabber').mousewheel(function (event) {
            if (!window.config) return;
            //console.log(event.deltaX, event.deltaY, event.deltaFactor);
            manager.scaleX(-event.deltaY * event.deltaFactor);
            if (drawer.deltaX)
            {
                drawer.scaleY(event.deltaX * event.deltaFactor);
            }
            drawer.drawLevel();
        });

        var grb_d3 = d3.select("#grabber");
        var grabber = grb_d3.node();

        grabber.onmousedown = function (e) {
            if (!window.config)
            {
                return;
            }
            drawer.drawTiles = false;
            clicked = true;
            prev_mouseX = e.clientX;
            prev_mouseY = e.clientY;
            if (e.stopPropagation) e.stopPropagation();
            if (e.preventDefault) e.preventDefault();

        };


        grabber.onmouseup = function (e) {
            if (!window.config) return;
            drawer.drawTiles = true;
            clicked = false;
            prev_mouseX = null;
            prev_mouseY = null;
            drawer.drawLevel();
        };


        main_graph.onclick = function (e) {
            if (!window.config) return;
            var svg = d3.select(".path_container");
            var w_pos = getCoords(svg.node());
            var x = e.clientX;
            var ix = drawer.getSelectX(x - w_pos.left);

            _this.selected = ix;
            drawer.drawLevel();

        };

        this.moveByTile = function (lvl_dir, ind_dir) {
            if (!manager) return;

            manager.move(lvl_dir, ind_dir);

        };

        this.moveByPos = function (ind_dir) {
            if (!manager) return;

            manager.movePos(ind_dir);

        };


        this.stepLvl = function (dir) {
            if (!manager) return;
            if (_this.selected)
            {
                manager.moveToPosition(dir, _this.selected);

            }
            else
            {
                _this.moveByTile(dir, 0);
            }
        };

        window.onkeydown = function checkKey(e) {

            e = e || window.event;


            if (e.altKey)
            {
                if (e.keyCode == 67)
                {
                    host = document.getElementById("ws_host").value;
                    manager = new ApplicationManager(host, drawer);
                }

            }

            if (e.keyCode == '38')
            {
                // up arrow
                _this.stepLvl(1);
            }
            else if (e.keyCode == '40')
            {
                // down arrow
                if (!manager) return;
                _this.stepLvl(-1);
            }
            else if (e.keyCode == '37')
            {
                // left arrow
                if (!manager) return;
                _this.moveByPos(-1);
            }
            else if (e.keyCode == '39')
            {
                // right arrow
                if (!manager) return;
                _this.moveByPos(+1);

            }
        };
    };


    main();


</script>


</body>


</html>